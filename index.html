<!--
  Gestionale Pazienti - PROFESSIONALE (single-file HTML)
  -----------------------------------------------------
  - Singolo file pronto per GitHub Pages
  - Ruoli: admin, medico (users collection)
  - Departments configurabili in Firestore (collection 'departments')
  - Pazienti legati a createdBy (uid) e department
  - Admin vede tutto; medico vede pazienti creati da lui o del suo reparto
  - Dashboard con grafici Chart.js (pazienti per reparto, appuntamenti prossimi 7 giorni)
  - No upload file

  ISTRUZIONI:
  1) Crea progetto Firebase, abilita Auth (Email/Password) e Firestore
  2) Aggiungi una Web App e copia la firebaseConfig sotto
  3) Pubblica in root di GitHub Pages

  NOTE SULLA SICUREZZA:
  - In ambiente di produzione configura regole Firestore che limitino l'accesso
    (nell'intestazione del file ho lasciato esempi commentati)
-->

<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestionale Pazienti - EMS Professionale</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}</style>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase modular SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js';

    // ====== CONFIG: incolla la tua firebaseConfig qui ======
const firebaseConfig = {
  apiKey: "AIzaSyBZJxyKCG2-8GUNIEqULL1R2orCNPbvAOU",
  authDomain: "emsfiacre.firebaseapp.com",
  projectId: "emsfiacre",
  storageBucket: "emsfiacre.firebasestorage.app",
  messagingSenderId: "172198127967",
  appId: "1:172198127967:web:dcccaef65929387b56eeea"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Utility globale
    window.Prof = {
      auth, db,
      // Auth
      register: async (email, pass, name, department, role='medico') => {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        // create users doc
        await setDoc(doc(db,'users',cred.user.uid), { uid: cred.user.uid, email, name, department, role });
        return cred;
      },
      login: (email, pass) => signInWithEmailAndPassword(auth, email, pass),
      logout: () => signOut(auth),
      // departments
      addDepartment: (d) => addDoc(collection(db,'departments'), { name: d }),
      getDepartments: async () => { const s = await getDocs(collection(db,'departments')); return s.docs.map(d=>({id:d.id,...d.data()})); },
      // users
      getUserDoc: async (uid) => { const d = await getDoc(doc(db,'users',uid)); return d.exists()? {id:d.id,...d.data()} : null; },
      // patients
      addPatient: (p) => addDoc(collection(db,'patients'), p),
      updatePatient: (id,data) => updateDoc(doc(db,'patients',id), data),
      deletePatient: (id) => deleteDoc(doc(db,'patients',id)),
      getAllPatients: async () => { const s = await getDocs(collection(db,'patients')); return s.docs.map(d=>({id:d.id,...d.data()})); },
      // appointments
      addAppointment: (a) => addDoc(collection(db,'appointments'), a),
      updateAppointment: (id,data) => updateDoc(doc(db,'appointments',id), data),
      deleteAppointment: (id) => deleteDoc(doc(db,'appointments',id)),
      getAllAppointments: async () => { const s = await getDocs(collection(db,'appointments')); return s.docs.map(d=>({id:d.id,...d.data()})); }
    };

    // UI logic
    document.addEventListener('DOMContentLoaded', ()=>{
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const logoutBtn = document.getElementById('logoutBtn');

      // Fill departments dropdowns
      async function populateDepartments(){
        const deps = await window.Prof.getDepartments();
        const selects = document.querySelectorAll('.dept-select');
        selects.forEach(s=>{ s.innerHTML = '<option value="">-- Seleziona reparto --</option>'; deps.forEach(d=>{ const o = document.createElement('option'); o.value = d.name; o.textContent = d.name; s.appendChild(o); }); });
      }

      populateDepartments();

      // Register
      registerForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const name = e.target.name.value, email = e.target.email.value, pass = e.target.password.value, dept = e.target.department.value;
        try{ await window.Prof.register(email,pass,name,dept); alert('Registrazione ok. Effettua il login.'); registerForm.reset(); populateDepartments(); }
        catch(err){ alert('Errore registrazione: '+err.message); }
      });

      // Login
      loginForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = e.target.email.value, pass = e.target.password.value;
        try{ await window.Prof.login(email,pass); loginForm.reset(); }
        catch(err){ alert('Errore login: '+err.message); }
      });

      // Logout
      logoutBtn.addEventListener('click', async ()=>{ await window.Prof.logout(); });

      // Navigation
      document.querySelectorAll('[data-nav]').forEach(b=> b.addEventListener('click', async (ev)=>{
        ev.preventDefault(); const target = b.dataset.nav; document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden')); document.getElementById(target).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('bg-sky-600','text-white')); b.classList.add('bg-sky-600','text-white');
        // load content per page
        if (target==='pageDashboard') await loadDashboard();
        if (target==='pagePatients') await loadPatients();
        if (target==='pageAppointments') await renderCalendar();
        if (target==='pageSettings') await loadSettings();
      }));

      // Auth state
      onAuthStateChanged(auth, async (user)=>{
        if (user){
          const userDoc = await window.Prof.getUserDoc(user.uid);
          window.currentUser = userDoc || { uid: user.uid, email: user.email, role: 'medico' };
          document.getElementById('authArea').classList.add('hidden');
          document.getElementById('appArea').classList.remove('hidden');
          document.getElementById('userDisplay').textContent = (window.currentUser.name||user.email) + (window.currentUser.department? ' ‚Äî '+window.currentUser.department : '');
          // default nav
          document.querySelector('[data-nav="pageDashboard"]').click();
          await populateDepartments();
        } else {
          document.getElementById('authArea').classList.remove('hidden');
          document.getElementById('appArea').classList.add('hidden');
        }
      });

      // Patient form
      document.getElementById('patientForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        const patient = {
          firstName: f.firstName.value, lastName: f.lastName.value,
          birthDate: f.birthDate.value, phone: f.phone.value,
          height: f.height.value, weight: f.weight.value,
          clinicalHistory: f.clinicalHistory.value, medications: f.medications.value,
          pathologies: f.pathologies.value, department: f.department.value || (window.currentUser && window.currentUser.department) || '',
          createdBy: window.currentUser.uid || null, createdAt: new Date().toISOString()
        };
        try{
          if (f.dataset.editId) { await window.Prof.updatePatient(f.dataset.editId, patient); delete f.dataset.editId; alert('Paziente aggiornato'); }
          else await window.Prof.addPatient(patient);
          f.reset(); closeModal(); await loadPatients();
        } catch(err){ alert('Errore: '+err.message); }
      });

      // Appointment form
      document.getElementById('appointmentForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        const appt = { title: f.title.value, patientId: f.patientId.value, start: f.start.value, end: f.end.value || f.start.value, notes: f.notes.value, createdBy: window.currentUser.uid, department: window.currentUser.department || '' };
        try{ await window.Prof.addAppointment(appt); f.reset(); alert('Appuntamento creato'); await renderCalendar(); }
        catch(err){ alert('Errore: '+err.message); }
      });

      // Department add (settings)
      document.getElementById('addDeptForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); const name = e.target.deptName.value; try{ await window.Prof.addDepartment(name); e.target.reset(); alert('Reparto aggiunto'); await loadSettings(); await populateDepartments(); } catch(err){ alert('Errore: '+err.message); }
      });

    }); // DOMContentLoaded

    // ---------------- Data loaders ----------------
    async function loadPatients(){
      const tbody = document.getElementById('patientsTbody'); tbody.innerHTML = '<tr><td colspan="6" class="p-4">Caricamento...</td></tr>';
      const all = await window.Prof.getAllPatients();
      // Filter based on role: admin sees all; medico sees createdBy=uid OR department==user.department
      let visible = all;
      if (window.currentUser && window.currentUser.role !== 'admin'){
        visible = all.filter(p => p.createdBy === window.currentUser.uid || p.department === window.currentUser.department);
      }
      if (!visible.length){ tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center">Nessun paziente visibile</td></tr>'; return; }
      tbody.innerHTML = '';
      visible.sort((a,b)=> (a.lastName||'').localeCompare(b.lastName||''));
      visible.forEach(p=>{
        const tr = document.createElement('tr'); tr.className='border-b';
        tr.innerHTML = `
          <td class="p-2">${escape(p.firstName)}</td>
          <td class="p-2">${escape(p.lastName)}</td>
          <td class="p-2">${escape(p.birthDate||'')}</td>
          <td class="p-2">${escape(p.phone||'')}</td>
          <td class="p-2">${escape(p.pathologies||'')}</td>
          <td class="p-2 text-right">
            <button class="open-px px-2 py-1 bg-sky-600 text-white rounded text-sm" data-id="${p.id}">Apri</button>
            ${p.createdBy === (window.currentUser && window.currentUser.uid) ? `<button class="del-px ml-2 px-2 py-1 bg-red-600 text-white rounded text-sm" data-id="${p.id}">Elimina</button>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.open-px').forEach(b=> b.addEventListener('click', async (ev)=>{
        const id = ev.currentTarget.dataset.id; const d = await getDocData('patients', id); if (!d) return alert('Non trovato'); populatePatientModal(d, id); showModal('Scheda Paziente');
      }));
      document.querySelectorAll('.del-px').forEach(b=> b.addEventListener('click', async (ev)=>{ const id=ev.currentTarget.dataset.id; if (!confirm('Elimina paziente?')) return; await window.Prof.deletePatient(id); await loadPatients(); }));

      // fill appointment patient selects
      const opts = document.querySelectorAll('.patient-select'); opts.forEach(s=>{ s.innerHTML = '<option value="">-- Seleziona paziente --</option>'; visible.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent = p.firstName+' '+p.lastName; s.appendChild(o); }); });

      // update dashboard lists
      const latest = visible.slice(0,5).map(p=> `<div class=\"py-1\">${escape(p.firstName)} ${escape(p.lastName)} <span class=\"text-xs text-gray-500\">${escape(p.department||'')}</span></div>`).join(''); document.getElementById('latestPatients').innerHTML = latest || '<div class="text-sm text-gray-500">Nessun paziente</div>';
    }

    async function getDocData(col,id){ try{ const d = await getDoc(doc(db,col,id)); if (!d.exists()) return null; return { id:d.id, ...d.data() }; } catch(e){ console.error(e); return null; } }

    function populatePatientModal(d,id){ const f=document.getElementById('patientForm'); f.firstName.value = d.firstName||''; f.lastName.value = d.lastName||''; f.birthDate.value = d.birthDate||''; f.phone.value = d.phone||''; f.height.value = d.height||''; f.weight.value = d.weight||''; f.clinicalHistory.value = d.clinicalHistory||''; f.medications.value = d.medications||''; f.pathologies.value = d.pathologies||''; f.department.value = d.department||''; f.dataset.editId = id; }

    // ---------------- Calendar ----------------
    let calendar;
    async function renderCalendar(){
      const el = document.getElementById('calendar'); el.innerHTML = '';
      const all = await window.Prof.getAllAppointments();
      let visible = all;
      if (window.currentUser && window.currentUser.role !== 'admin') visible = all.filter(a => a.createdBy === window.currentUser.uid || a.department === window.currentUser.department);
      const evs = visible.map(a=>({ id:a.id, title: a.title + (a.patientName? ' ‚Äî '+a.patientName : ''), start: a.start, end: a.end }));
      calendar = new FullCalendar.Calendar(el, { initialView: 'dayGridMonth', headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay'}, events: evs, eventClick: info=>{ showModal(`<div class=\"p-2\"><strong>${escape(info.event.title)}</strong><div class=\"text-sm text-gray-600\">${escape(info.event.start?.toISOString().replace('T',' ').slice(0,19)||'')}</div></div>`); } });
      calendar.render();
    }

    // ---------------- Dashboard ----------------
    async function loadDashboard(){
      // stats: patients count visible, appointments today, upcoming 7 days chart, patients per department chart
      const patients = await window.Prof.getAllPatients();
      let visiblePatients = patients;
      if (window.currentUser && window.currentUser.role !== 'admin') visiblePatients = patients.filter(p => p.createdBy === window.currentUser.uid || p.department === window.currentUser.department);
      document.getElementById('statPatients').textContent = visiblePatients.length;

      const appts = await window.Prof.getAllAppointments();
      let visibleAppts = appts;
      if (window.currentUser && window.currentUser.role !== 'admin') visibleAppts = appts.filter(a => a.createdBy === window.currentUser.uid || a.department === window.currentUser.department);
      const today = new Date().toISOString().slice(0,10);
      const todayCount = visibleAppts.filter(a => (a.start||'').slice(0,10)===today).length;
      document.getElementById('statToday').textContent = todayCount;

      // patients per department
      const deps = await window.Prof.getDepartments();
      const depNames = deps.map(d=>d.name);
      const counts = depNames.map(n => visiblePatients.filter(p => p.department === n).length);
      renderBarChart('chartPatientsDept', depNames, counts, 'Pazienti per reparto');

      // appointments next 7 days
      const days = []; const apptsCount = [];
      for (let i=0;i<7;i++){ const dt = new Date(); dt.setDate(dt.getDate()+i); const key = dt.toISOString().slice(0,10); days.push(key); apptsCount.push(visibleAppts.filter(a => (a.start||'').slice(0,10)===key).length); }
      renderLineChart('chartAppts7d', days, apptsCount, 'Appuntamenti prossimi 7 giorni');

      // latest patients
      const latest = visiblePatients.slice().sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||'')).slice(0,5);
      document.getElementById('latestPatients').innerHTML = latest.map(p=> `<div class=\"py-1\">${escape(p.firstName)} ${escape(p.lastName)} <span class=\"text-xs text-gray-500\">${escape(p.department||'')}</span></div>`).join('') || '<div class="text-sm text-gray-500">Nessun paziente</div>';
    }

    // ---------------- Settings ----------------
    async function loadSettings(){
      const list = document.getElementById('departmentsList'); list.innerHTML = 'Caricamento...';
      const deps = await window.Prof.getDepartments(); list.innerHTML = '';
      deps.forEach(d=>{ const div = document.createElement('div'); div.className='p-2 border-b flex justify-between items-center'; div.innerHTML = `<div>${escape(d.name)}</div>`; list.appendChild(div); });
      // only admins can add departments - UI already hides form if not admin
      if (window.currentUser && window.currentUser.role !== 'admin') document.getElementById('addDeptCard').classList.add('hidden'); else document.getElementById('addDeptCard').classList.remove('hidden');
    }

    // ---------------- Charts ----------------
    let charts = {};
    function renderBarChart(canvasId, labels, data, label){ const ctx = document.getElementById(canvasId); if (!ctx) return; if (charts[canvasId]) charts[canvasId].destroy(); charts[canvasId] = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label, data }] }, options:{ responsive:true } }); }
    function renderLineChart(canvasId, labels, data, label){ const ctx = document.getElementById(canvasId); if (!ctx) return; if (charts[canvasId]) charts[canvasId].destroy(); charts[canvasId] = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label, data, tension:0.3 }] }, options:{ responsive:true } }); }

    // ---------------- Modal ----------------
    function showModal(title){ document.getElementById('modalTitle').textContent = title; document.getElementById('modal').classList.remove('hidden'); }
    function closeModal(){ document.getElementById('modal').classList.add('hidden'); document.getElementById('modalBody').scrollTop = 0; }

    // ---------------- Utils ----------------
    function escape(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    window.loadPatients = loadPatients; window.renderCalendar = renderCalendar; window.loadDashboard = loadDashboard; window.loadSettings = loadSettings; window.closeModal = closeModal;

  </script>

  <style>
    .sidebar { background: linear-gradient(180deg,#022c41 0%, #063047 100%); }
    .nav-item { transition: all .15s ease; }
    .page { min-height:60vh; }
  </style>
</head>
<body class="bg-gray-50">
  <!-- AUTH -->
  <div id="authArea" class="min-h-screen flex items-center justify-center p-6">
    <div class="max-w-4xl w-full grid grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-lg font-semibold mb-4">Accedi</h2>
        <form id="loginForm" class="space-y-3">
          <input name="email" type="email" required placeholder="Email" class="w-full p-2 border rounded" />
          <input name="password" type="password" required placeholder="Password" class="w-full p-2 border rounded" />
          <div class="flex gap-2"><button class="px-4 py-2 bg-sky-600 text-white rounded">Accedi</button></div>
        </form>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-lg font-semibold mb-4">Crea account (staff)</h2>
        <form id="registerForm" class="space-y-3">
          <input name="name" placeholder="Nome e cognome" class="w-full p-2 border rounded" required />
          <input name="email" type="email" placeholder="Email" class="w-full p-2 border rounded" required />
          <input name="password" type="password" placeholder="Password" class="w-full p-2 border rounded" required />
          <select name="department" class="dept-select w-full p-2 border rounded"></select>
          <div class="flex gap-2"><button class="px-4 py-2 bg-green-600 text-white rounded">Registrati</button></div>
          <div class="text-xs text-gray-500 mt-2">Il campo reparto pu√≤ essere lasciato vuoto e impostato successivamente.</div>
        </form>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appArea" class="hidden min-h-screen flex">
    <aside class="sidebar w-64 text-white p-6 flex flex-col">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-white/10 rounded flex items-center justify-center font-bold">EMS</div>
        <div>
          <div class="font-bold text-lg">EMS Professionale</div>
          <div class="text-sm text-white/80">Gestionale Pazienti</div>
        </div>
      </div>
      <nav class="space-y-1 mb-4">
        <a href="#" class="block px-3 py-2 rounded nav-item bg-sky-600 text-white" data-nav="pageDashboard">üè† Dashboard</a>
        <a href="#" class="block px-3 py-2 rounded nav-item" data-nav="pagePatients">üë®‚Äç‚öïÔ∏è Pazienti</a>
        <a href="#" class="block px-3 py-2 rounded nav-item" data-nav="pageAppointments">üìÖ Appuntamenti</a>
        <a href="#" class="block px-3 py-2 rounded nav-item" data-nav="pageExams">üß™ Esami</a>
        <a href="#" class="block px-3 py-2 rounded nav-item" data-nav="pageSettings">‚öôÔ∏è Impostazioni</a>
      </nav>
      <div class="mt-auto">
        <div id="userDisplay" class="text-sm"></div>
        <button id="logoutBtn" class="mt-3 w-full bg-red-600 px-3 py-2 rounded">Logout</button>
      </div>
    </aside>

    <main class="flex-1 p-8">
      <header class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-semibold">Benvenuto</h2>
          <div class="text-sm text-gray-500">Sistema gestionale medico professionale</div>
        </div>
        <div class="flex items-center gap-3">
          <button class="px-3 py-2 bg-gray-100 rounded" onclick="loadDashboard()">Aggiorna</button>
        </div>
      </header>

      <!-- Pages -->
      <section id="pageDashboard" class="page">
        <div class="grid grid-cols-3 gap-6 mb-6">
          <div class="bg-white p-4 rounded shadow-sm"><div class="text-sm text-gray-500">Totale Pazienti</div><div id="statPatients" class="text-2xl font-bold mt-2">0</div></div>
          <div class="bg-white p-4 rounded shadow-sm"><div class="text-sm text-gray-500">Appuntamenti oggi</div><div id="statToday" class="text-2xl font-bold mt-2">0</div></div>
          <div class="bg-white p-4 rounded shadow-sm"><div class="text-sm text-gray-500">In arrivo</div><div id="statUpcoming" class="text-2xl font-bold mt-2">-</div></div>
        </div>
        <div class="grid grid-cols-2 gap-6">
          <div class="bg-white p-4 rounded shadow-sm">
            <h4 class="font-semibold mb-2">Pazienti per reparto</h4>
            <canvas id="chartPatientsDept" height="120"></canvas>
          </div>
          <div class="bg-white p-4 rounded shadow-sm">
            <h4 class="font-semibold mb-2">Appuntamenti prossimi 7 giorni</h4>
            <canvas id="chartAppts7d" height="120"></canvas>
          </div>
        </div>
        <div class="mt-6 bg-white p-4 rounded shadow-sm">
          <h4 class="font-semibold mb-2">Ultimi pazienti</h4>
          <div id="latestPatients" class="text-sm text-gray-600"></div>
        </div>
      </section>

      <section id="pagePatients" class="page hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold">Pazienti</h3>
          <div>
            <button onclick="document.getElementById('patientForm').reset(); delete document.getElementById('patientForm').dataset.editId; showModal('Nuovo Paziente');" class="px-3 py-2 bg-sky-600 text-white rounded">Nuovo paziente</button>
          </div>
        </div>
        <div class="bg-white rounded shadow-sm overflow-auto">
          <table class="w-full text-left">
            <thead class="bg-gray-50 text-sm text-gray-600"><tr><th class="p-2">Nome</th><th class="p-2">Cognome</th><th class="p-2">Nascita</th><th class="p-2">Telefono</th><th class="p-2">Patologie</th><th class="p-2 text-right">Azioni</th></tr></thead>
            <tbody id="patientsTbody" class="text-sm"></tbody>
          </table>
        </div>
      </section>

      <section id="pageAppointments" class="page hidden">
        <div class="mb-4 grid grid-cols-3 gap-4">
          <div class="col-span-1 bg-white p-4 rounded shadow-sm">
            <h4 class="font-semibold mb-2">Nuovo appuntamento</h4>
            <form id="appointmentForm" class="space-y-2">
              <input name="title" placeholder="Titolo" class="w-full p-2 border rounded" required />
              <select class="patient-select w-full p-2 border rounded" name="patientId"></select>
              <div class="grid grid-cols-2 gap-2"><input type="datetime-local" name="start" class="p-2 border rounded" required /><input type="datetime-local" name="end" class="p-2 border rounded" /></div>
              <textarea name="notes" placeholder="Note" class="w-full p-2 border rounded"></textarea>
              <div class="flex gap-2"><button class="px-3 py-2 bg-sky-600 text-white rounded">Salva</button></div>
            </form>
          </div>
          <div class="col-span-2 bg-white p-4 rounded shadow-sm">
            <div id="calendar"></div>
          </div>
        </div>
      </section>

      <section id="pageExams" class="page hidden">
        <div class="bg-white p-4 rounded shadow-sm">Sezione Esami (semplice elenco per ora)</div>
      </section>

      <section id="pageSettings" class="page hidden">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-white p-4 rounded shadow-sm" id="addDeptCard">
            <h4 class="font-semibold mb-2">Aggiungi reparto</h4>
            <form id="addDeptForm" class="space-y-2"><input name="deptName" placeholder="Nome reparto" class="w-full p-2 border rounded" required /><div class="flex gap-2"><button class="px-3 py-2 bg-sky-600 text-white rounded">Aggiungi</button></div></form>
          </div>
          <div class="bg-white p-4 rounded shadow-sm"><h4 class="font-semibold mb-2">Reparti esistenti</h4><div id="departmentsList"></div></div>
        </div>
      </section>

    </main>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-2xl rounded shadow p-4">
      <div class="flex justify-between items-center mb-3"><h3 id="modalTitle" class="font-semibold">Modal</h3><button onclick="closeModal()" class="text-gray-600">Chiudi</button></div>
      <div id="modalBody">
        <form id="patientForm" class="space-y-2">
          <div class="grid grid-cols-2 gap-2"><input name="firstName" placeholder="Nome" class="p-2 border rounded" required /><input name="lastName" placeholder="Cognome" class="p-2 border rounded" required /></div>
          <div class="grid grid-cols-2 gap-2"><input name="birthDate" type="date" class="p-2 border rounded" /><input name="phone" placeholder="Telefono" class="p-2 border rounded" /></div>
          <div class="grid grid-cols-2 gap-2"><input name="height" placeholder="Altezza (cm)" class="p-2 border rounded" /><input name="weight" placeholder="Peso (kg)" class="p-2 border rounded" /></div>
          <select name="department" class="dept-select p-2 border rounded"></select>
          <textarea name="clinicalHistory" placeholder="Storia clinica" class="p-2 border rounded"></textarea>
          <textarea name="medications" placeholder="Farmaci" class="p-2 border rounded"></textarea>
          <textarea name="pathologies" placeholder="Patologie" class="p-2 border rounded"></textarea>
          <div class="flex justify-end gap-2"><button type="button" onclick="closeModal()" class="px-3 py-2 bg-gray-200 rounded">Annulla</button><button class="px-3 py-2 bg-sky-600 text-white rounded">Salva paziente</button></div>
        </form>
      </div>
    </div>
  </div>

</body>
</html>
