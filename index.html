<!--
  Gestionale Pazienti - single-file HTML
  -------------------------------------
  Cosa fa:
   - Login / Registrazione con Firebase Authentication (email/password)
   - Usa Cloud Firestore per salvare:
       * collection `patients` (anagrafica, storia clinica, farmaci, visite, esami, ecc.)
       * collection `appointments` (calendario appuntamenti)
   - CRUD pazienti + calendario appuntamenti (FullCalendar)
   - Design moderno con Tailwind CSS

  ISTRUZIONI:
   1) Crea un progetto Firebase e abilita Authentication (Email/Password) e Cloud Firestore.
   2) Copia la tua config Firebase nella costante `firebaseConfig` più sotto.
   3) Pubblica il file su GitHub Pages o sul vostro hosting statico.
   4) Imposta regole Firestore adeguate (es. consentire accesso solo ad utenti autenticati).

  NOTE DI SICUREZZA:
   - Non includere chiavi private o file sensibili nel repository pubblico.
   - Config Firebase contiente solo chiavi pubbliche del client; proteggi l'accesso tramite regole Firestore.

  Questo file è pronto per essere scaricato e modificato.
-->

<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gestionale Pazienti - EMS / Fiacre (FiveM RP)</title>

  <!-- Tailwind via CDN (per semplicità) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FullCalendar (for calendario) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

  <!-- Firebase SDKs -->
  <script type="module">
    // Modular SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js';

    // === CONFIG: inserisci qui la tua config Firebase ===
const firebaseConfig = {
  apiKey: "AIzaSyBZJxyKCG2-8GUNIEqULL1R2orCNPbvAOU",
  authDomain: "emsfiacre.firebaseapp.com",
  projectId: "emsfiacre",
  storageBucket: "emsfiacre.firebasestorage.app",
  messagingSenderId: "172198127967",
  appId: "1:172198127967:web:dcccaef65929387b56eeea"
};

    // === Inizializzazione ===
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Esponi alcune funzioni globalmente per l'HTML (semplice) -> prefisso FP (FiveP)
    window.FP = {
      auth, db,
      // Auth
      register: async (email, password) => {
        return createUserWithEmailAndPassword(auth, email, password);
      },
      login: async (email, password) => {
        return signInWithEmailAndPassword(auth, email, password);
      },
      logout: async () => {
        return signOut(auth);
      },

      // Patients CRUD
      addPatient: async (patient) => {
        const col = collection(db, 'patients');
        return addDoc(col, patient);
      },
      updatePatient: async (id, data) => {
        const d = doc(db, 'patients', id);
        return updateDoc(d, data);
      },
      deletePatient: async (id) => {
        const d = doc(db, 'patients', id);
        return deleteDoc(d);
      },
      getAllPatients: async () => {
        const snap = await getDocs(collection(db, 'patients'));
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      },

      // Appointments CRUD
      addAppointment: async (appointment) => {
        const col = collection(db, 'appointments');
        return addDoc(col, appointment);
      },
      updateAppointment: async (id, data) => {
        const d = doc(db, 'appointments', id);
        return updateDoc(d, data);
      },
      deleteAppointment: async (id) => {
        const d = doc(db, 'appointments', id);
        return deleteDoc(d);
      },
      getAllAppointments: async () => {
        const snap = await getDocs(collection(db, 'appointments'));
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }
    };

    // Auth state listener -> aggiorna UI
    window.addEventListener('DOMContentLoaded', () => {
      const userEmailEl = document.getElementById('userEmail');
      const authSection = document.getElementById('authSection');
      const appSection = document.getElementById('appSection');

      onAuthStateChanged(auth, user => {
        if (user) {
          authSection.classList.add('hidden');
          appSection.classList.remove('hidden');
          userEmailEl.textContent = user.email;
          loadPatientsList();
          initCalendar();
        } else {
          authSection.classList.remove('hidden');
          appSection.classList.add('hidden');
        }
      });

      // Forms
      document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = e.target.email.value;
        const pass = e.target.password.value;
        try {
          await window.FP.register(email, pass);
          alert('Registrazione completata. Sei connesso.');
          e.target.reset();
        } catch (err) { alert('Errore registrazione: ' + err.message); }
      });

      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = e.target.email.value;
        const pass = e.target.password.value;
        try {
          await window.FP.login(email, pass);
          e.target.reset();
        } catch (err) { alert('Errore login: ' + err.message); }
      });

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await window.FP.logout();
      });

      // Patient form
      document.getElementById('patientForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const data = {
          firstName: form.firstName.value,
          lastName: form.lastName.value,
          birthDate: form.birthDate.value,
          phone: form.phone.value,
          height: form.height.value,
          weight: form.weight.value,
          clinicalHistory: form.clinicalHistory.value,
          medications: form.medications.value,
          firstVisit: form.firstVisit.value,
          nextVisit: form.nextVisit.value,
          pathologies: form.pathologies.value,
          chemExams: form.chemExams.value,
          instrumentExams: form.instrumentExams.value,
          createdAt: new Date().toISOString()
        };

        try {
          if (form.dataset.editId) {
            await window.FP.updatePatient(form.dataset.editId, data);
            delete form.dataset.editId;
            alert('Paziente aggiornato');
          } else {
            await window.FP.addPatient(data);
            alert('Paziente aggiunto');
          }
          form.reset();
          loadPatientsList();
        } catch (err) { alert('Errore: ' + err.message); }
      });

      // Appointment form
      document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const f = e.target;
        const appt = {
          title: f.title.value,
          patientId: f.patientId.value,
          start: f.start.value,
          end: f.end.value || f.start.value,
          notes: f.notes.value
        };
        try {
          await window.FP.addAppointment(appt);
          alert('Appuntamento creato');
          f.reset();
          renderCalendarEvents();
        } catch (err) { alert('Errore: ' + err.message); }
      });

      // Cerca paziente
      document.getElementById('searchPatient').addEventListener('input', () => loadPatientsList());

    }); // end DOMContentLoaded

    // --- Funzioni helper per UI e dati ---
    async function loadPatientsList() {
      const list = document.getElementById('patientsList');
      const selectPatients = document.getElementById('appointmentPatientSelect');
      list.innerHTML = 'Caricamento...';
      selectPatients.innerHTML = '<option value="">-- Seleziona paziente --</option>';
      try {
        const patients = await window.FP.getAllPatients();
        if (!patients.length) { list.innerHTML = '<div class="text-sm text-muted">Nessun paziente presente</div>'; return; }
        list.innerHTML = '';
        patients.forEach(p => {
          const el = document.createElement('div');
          el.className = 'p-3 border rounded-lg flex justify-between items-start gap-4 mb-2 bg-white shadow-sm';
          el.innerHTML = `
            <div>
              <div class="font-semibold">${escapeHtml(p.firstName || '')} ${escapeHtml(p.lastName || '')}</div>
              <div class="text-sm text-gray-600">Nato: ${escapeHtml(p.birthDate || '')} • Tel: ${escapeHtml(p.phone || '')}</div>
              <div class="text-sm mt-2">Patologie: ${escapeHtml(p.pathologies || '')}</div>
            </div>
            <div class="flex gap-2">
              <button class="btn-edit px-3 py-1 rounded bg-indigo-600 text-white text-sm" data-id="${p.id}">Modifica</button>
              <button class="btn-delete px-3 py-1 rounded bg-red-600 text-white text-sm" data-id="${p.id}">Elimina</button>
            </div>
          `;
          list.appendChild(el);

          // Option per select appuntamento
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = `${p.firstName} ${p.lastName}`;
          selectPatients.appendChild(opt);
        });

        // delega events
        list.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', async (ev) => {
          const id = ev.currentTarget.dataset.id;
          const d = await getDocPromise('patients', id);
          if (!d) return alert('Documento non trovato');
          const form = document.getElementById('patientForm');
          form.firstName.value = d.firstName || '';
          form.lastName.value = d.lastName || '';
          form.birthDate.value = d.birthDate || '';
          form.phone.value = d.phone || '';
          form.height.value = d.height || '';
          form.weight.value = d.weight || '';
          form.clinicalHistory.value = d.clinicalHistory || '';
          form.medications.value = d.medications || '';
          form.firstVisit.value = d.firstVisit || '';
          form.nextVisit.value = d.nextVisit || '';
          form.pathologies.value = d.pathologies || '';
          form.chemExams.value = d.chemExams || '';
          form.instrumentExams.value = d.instrumentExams || '';
          form.dataset.editId = id;
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }));

        list.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', async (ev) => {
          const id = ev.currentTarget.dataset.id;
          if (!confirm('Confermi eliminazione paziente?')) return;
          await window.FP.deletePatient(id);
          loadPatientsList();
        }));

      } catch (err) { list.innerHTML = 'Errore caricamento: '+err.message; }
    }

    // small helper to fetch single doc data
    async function getDocPromise(collectionName, id) {
      try {
        const dRef = doc(window.FP.db, collectionName, id);
        const snap = await getDoc(dRef);
        if (!snap.exists()) return null;
        return snap.data();
      } catch (err) { console.error(err); return null; }
    }

    // Basic XSS escape for small renders
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

    // --- CALENDAR ---
    let calendar;
    async function initCalendar(){
      // wait element
      const calendarEl = document.getElementById('calendar');
      // load events from Firestore
      const events = await window.FP.getAllAppointments();
      const calendarEvents = events.map(e => ({ id: e.id, title: e.title + (e.patientId? ' • '+e.patientId : ''), start: e.start, end: e.end, extendedProps: { notes: e.notes, patientId: e.patientId } }));

      if (calendar) { calendar.remove(); }
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        events: calendarEvents,
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
        eventClick: function(info){
          const e = info.event;
          const props = e.extendedProps || {};
          let html = `<div class="p-3">`;
          html += `<div class="font-semibold">${escapeHtml(e.title)}</div>`;
          html += `<div class="text-sm">${escapeHtml(e.start?.toISOString().slice(0,19).replace('T',' ' ) || '')}</div>`;
          if (props.notes) html += `<div class="mt-2">Note: ${escapeHtml(props.notes)}</div>`;
          if (props.patientId) html += `<div class="mt-2">Paziente ID: ${escapeHtml(props.patientId)}</div>`;
          html += `</div>`;
          showModalContent('Dettaglio Appuntamento', html);
        }
      });
      calendar.render();
    }

    async function renderCalendarEvents(){
      if (!calendar) return initCalendar();
      const events = await window.FP.getAllAppointments();
      calendar.removeAllEvents();
      events.forEach(e => calendar.addEvent({ id: e.id, title: e.title, start: e.start, end: e.end, extendedProps: { notes: e.notes, patientId: e.patientId } }));
    }

    // Modal helper
    function showModalContent(title, html){
      const modal = document.getElementById('modal');
      document.getElementById('modalTitle').innerHTML = title;
      document.getElementById('modalBody').innerHTML = html;
      modal.classList.remove('hidden');
    }
    function closeModal(){ document.getElementById('modal').classList.add('hidden'); }

    // Esporta paziente come JSON (semplice)
    async function exportPatients(){
      const patients = await window.FP.getAllPatients();
      const blob = new Blob([JSON.stringify(patients, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'patients_export.json'; a.click(); URL.revokeObjectURL(url);
    }

    // Esporta appuntamenti
    async function exportAppointments(){
      const appts = await window.FP.getAllAppointments();
      const blob = new Blob([JSON.stringify(appts, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'appointments_export.json'; a.click(); URL.revokeObjectURL(url);
    }

    // Make functions global used by HTML buttons
    window.loadPatientsList = loadPatientsList;
    window.initCalendar = initCalendar;
    window.renderCalendarEvents = renderCalendarEvents;
    window.showModalContent = showModalContent;
    window.closeModal = closeModal;
    window.exportPatients = exportPatients;
    window.exportAppointments = exportAppointments;

  </script>

  <style>
    /* small visual tweaks */
    body { background: linear-gradient(180deg,#f8fafc 0%, #eef2ff 100%); }
  </style>
</head>
<body class="min-h-screen font-sans text-gray-800">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Gestionale Pazienti • EMS / Fiacre (FiveM RP)</h1>
      <div id="authUI" class="flex items-center gap-3">
        <span id="userEmail" class="text-sm text-gray-600"></span>
        <button id="logoutBtn" class="bg-red-600 text-white px-3 py-1 rounded hidden">Logout</button>
      </div>
    </header>

    <!-- AUTH SECTION -->
    <div id="authSection" class="grid grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="font-semibold mb-2">Accedi</h2>
        <form id="loginForm" class="space-y-3">
          <input name="email" type="email" required placeholder="Email" class="w-full p-2 border rounded" />
          <input name="password" type="password" required placeholder="Password" class="w-full p-2 border rounded" />
          <div class="flex gap-2">
            <button class="px-4 py-2 bg-indigo-600 text-white rounded">Accedi</button>
          </div>
        </form>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="font-semibold mb-2">Registrati (staff)</h2>
        <form id="registerForm" class="space-y-3">
          <input name="email" type="email" required placeholder="Email" class="w-full p-2 border rounded" />
          <input name="password" type="password" required placeholder="Password" class="w-full p-2 border rounded" />
          <button class="px-4 py-2 bg-green-600 text-white rounded">Crea account</button>
        </form>
      </div>
    </div>

    <!-- APP SECTION -->
    <div id="appSection" class="hidden">
      <div class="grid grid-cols-3 gap-6">
        <!-- Left: Form paziente -->
        <div class="col-span-1 bg-white p-6 rounded-lg shadow">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold">Anagrafica / Clinica</h3>
            <div class="flex gap-2">
              <button onclick="exportPatients()" class="text-sm px-3 py-1 rounded bg-gray-100">Esporta JSON</button>
            </div>
          </div>

          <form id="patientForm" class="space-y-2">
            <div class="grid grid-cols-2 gap-2">
              <input name="firstName" placeholder="Nome" class="p-2 border rounded" required />
              <input name="lastName" placeholder="Cognome" class="p-2 border rounded" required />
            </div>
            <input name="birthDate" type="date" class="p-2 border rounded" />
            <input name="phone" placeholder="Telefono" class="p-2 border rounded" />
            <div class="grid grid-cols-2 gap-2">
              <input name="height" placeholder="Altezza (cm)" class="p-2 border rounded" />
              <input name="weight" placeholder="Peso (kg)" class="p-2 border rounded" />
            </div>
            <textarea name="clinicalHistory" placeholder="Storia clinica" class="p-2 border rounded"></textarea>
            <textarea name="medications" placeholder="Farmaci assunti" class="p-2 border rounded"></textarea>
            <div class="grid grid-cols-2 gap-2">
              <input name="firstVisit" type="date" placeholder="Prima visita" class="p-2 border rounded" />
              <input name="nextVisit" type="date" placeholder="Prossima visita" class="p-2 border rounded" />
            </div>
            <textarea name="pathologies" placeholder="Patologie" class="p-2 border rounded"></textarea>
            <textarea name="chemExams" placeholder="Esami chimici" class="p-2 border rounded"></textarea>
            <textarea name="instrumentExams" placeholder="Esami strumentali" class="p-2 border rounded"></textarea>
            <div class="flex gap-2">
              <button class="px-4 py-2 bg-indigo-600 text-white rounded">Salva paziente</button>
              <button type="button" onclick="document.getElementById('patientForm').reset()" class="px-4 py-2 bg-gray-200 rounded">Reset</button>
            </div>
          </form>

        </div>

        <!-- Middle: Lista pazienti -->
        <div class="col-span-1 bg-white p-6 rounded-lg shadow">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold">Lista Pazienti</h3>
            <input id="searchPatient" placeholder="Cerca..." class="p-2 border rounded text-sm" />
          </div>
          <div id="patientsList" class="max-h-[60vh] overflow-auto"></div>
        </div>

        <!-- Right: Calendario e appuntamenti -->
        <div class="col-span-1 bg-white p-6 rounded-lg shadow">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold">Appuntamenti</h3>
            <div class="flex gap-2">
              <button onclick="renderCalendarEvents()" class="px-3 py-1 bg-gray-100 rounded text-sm">Aggiorna</button>
              <button onclick="exportAppointments()" class="px-3 py-1 bg-gray-100 rounded text-sm">Esporta</button>
            </div>
          </div>

          <form id="appointmentForm" class="space-y-2 mb-4">
            <input name="title" placeholder="Titolo appuntamento" class="p-2 border rounded" required />
            <select id="appointmentPatientSelect" name="patientId" class="p-2 border rounded w-full"></select>
            <input name="start" type="datetime-local" class="p-2 border rounded" required />
            <input name="end" type="datetime-local" class="p-2 border rounded" />
            <textarea name="notes" placeholder="Note" class="p-2 border rounded"></textarea>
            <div class="flex gap-2">
              <button class="px-4 py-2 bg-indigo-600 text-white rounded">Crea appuntamento</button>
            </div>
          </form>

          <div id="calendar" class="bg-white rounded p-2"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white w-11/12 md:w-2/3 p-4 rounded-lg">
      <div class="flex justify-between items-center mb-2">
        <h4 id="modalTitle" class="font-bold">Titolo</h4>
        <button onclick="closeModal()" class="text-gray-600">Chiudi</button>
      </div>
      <div id="modalBody" class="text-sm"></div>
    </div>
  </div>

  <script>
    // show logout button only when authenticated
    const authObserver = setInterval(() => {
      const email = document.getElementById('userEmail').textContent;
      const logout = document.getElementById('logoutBtn');
      if (email) { logout.classList.remove('hidden'); } else { logout.classList.add('hidden'); }
    }, 500);
  </script>

</body>
</html>
